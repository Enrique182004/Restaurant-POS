<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Personaliza Tu Sushi</title>
    <link rel="stylesheet" href="/static/css/tablet.css">
</head>

<body>
    <div class="container">
        <h1 class="page-title">¬øC√≥mo Armar Tu Sushi?</h1>
        
        <form action="{{ url_for('update_item', item_index=item_index) if item else url_for('customize_sushi') }}" method="POST" id="customizationForm">
            
            <!-- Step 1: Select Base -->
            <div class="customization-step">
                <h2 class="step-title">1. Selecciona la Base</h2>
                <div class="option-grid base-options">
                    <div class="option-card {% if item and 'Queso Crema' in item.base %}selected{% endif %}">
                        <input type="checkbox" id="queso_crema" name="base" value="Queso Crema" 
                            {% if item and "Queso Crema" in item.base %} checked {% endif %} class="hidden-input">
                        <label for="queso_crema" class="card-content">
                            <div class="option-icon">üßÄ</div>
                            <div class="option-name">Queso Crema</div>
                        </label>
                    </div>
                    
                    <div class="option-card {% if item and 'Aguacate' in item.base %}selected{% endif %}">
                        <input type="checkbox" id="aguacate" name="base" value="Aguacate" 
                            {% if item and "Aguacate" in item.base %} checked {% endif %} class="hidden-input">
                        <label for="aguacate" class="card-content">
                            <div class="option-icon">ü•ë</div>
                            <div class="option-name">Aguacate</div>
                        </label>
                    </div>
                    
                    <div class="option-card {% if item and not item.base %}selected{% endif %}">
                        <input type="checkbox" id="none_base" name="base" value="None" 
                            {% if item and not item.base %} checked {% endif %} class="hidden-input">
                        <label for="none_base" class="card-content">
                            <div class="option-icon">üö´</div>
                            <div class="option-name">None</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Step 2: Select Ingredients -->
            <div class="customization-step">
                <h2 class="step-title">2. Selecciona de 1 a 3 ingredientes + Osti√≥n opcional</h2>
                
                <!-- Regular Ingredients -->
                <h3 class="sub-title">Ingredientes Regulares</h3>
                <div class="option-grid ingredients-grid">
                    {% set regular_ingredients = [
                        {"id": "camar√≥n", "name": "Camar√≥n", "icon": "ü¶ê"},
                        {"id": "sirloin", "name": "Sirloin", "icon": "ü•©"},
                        {"id": "surimi", "name": "Surimi", "icon": "ü¶Ä"},
                        {"id": "pastor", "name": "Pastor", "icon": "üåÆ"},
                        {"id": "pollo", "name": "Pollo", "icon": "üçó"},
                        {"id": "tocino", "name": "Tocino", "icon": "ü•ì"},
                        {"id": "jalape√±o", "name": "Jalape√±o", "icon": "üå∂Ô∏è"},
                        {"id": "pepino", "name": "Pepino", "icon": "ü•í"}
                    ] %}
                    
                    {% for ingredient in regular_ingredients %}
                    <div class="option-card {% if item and ingredient.name in item.ingredients %}selected{% endif %}">
                        <input type="checkbox" id="{{ ingredient.id }}" name="ingredients" value="{{ ingredient.name }}" 
                            {% if item and ingredient.name in item.ingredients %} checked {% endif %} class="hidden-input ingredient-checkbox">
                        <label for="{{ ingredient.id }}" class="card-content">
                            <div class="option-icon">{{ ingredient.icon }}</div>
                            <div class="option-name">{{ ingredient.name }}</div>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Osti√≥n as Premium Add-on -->
                <h3 class="sub-title">Ingrediente Premium</h3>
                <div class="option-grid premium-grid">
                    <div class="option-card {% if item and 'Osti√≥n' in item.ingredients %}selected{% endif %}">
                        <input type="checkbox" id="ostion" name="ingredients" value="Osti√≥n" 
                            {% if item and "Osti√≥n" in item.ingredients %} checked {% endif %} class="hidden-input ingredient-checkbox">
                        <label for="ostion" class="card-content">
                            <div class="option-icon">ü¶™</div>
                            <div class="option-name">Osti√≥n</div>
                            <div class="premium-badge">+$10</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Step 3: Fr√≠o o Empanizado -->
            <div class="customization-step">
                <h2 class="step-title">3. ¬øFr√≠o o Empanizado?</h2>
                <div class="option-grid style-options">
                    <div class="option-card radio-card {% if item and item.style == 'Fr√≠o' %}selected{% endif %}">
                        <input type="radio" id="frio" name="style" value="Fr√≠o" required 
                            {% if item and item.style == "Fr√≠o" %} checked {% endif %} class="hidden-input">
                        <label for="frio" class="card-content">
                            <div class="option-icon">‚ùÑÔ∏è</div>
                            <div class="option-name">Fr√≠o</div>
                        </label>
                    </div>
                    
                    <div class="option-card radio-card {% if item and item.style == 'Empanizado' %}selected{% endif %}">
                        <input type="radio" id="empanizado" name="style" value="Empanizado" required 
                            {% if item and item.style == "Empanizado" %} checked {% endif %} class="hidden-input">
                        <label for="empanizado" class="card-content">
                            <div class="option-icon">üçû</div>
                            <div class="option-name">Empanizado</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Step 4: Preparado -->
            <div class="customization-step">
                <h2 class="step-title">4. ¬øPreparado?</h2>
                <div class="option-grid preparation-options">
                    {% set preps = [
                        {"id": "sushi_preparado", "name": "Sushi Preparado", "icon": "üç±", "price": 115},
                        {"id": "sushi_seco", "name": "Sushi Seco", "icon": "üç£", "price": 110},
                        {"id": "sushi_salsas_aparte", "name": "Sushi Salsas Aparte", "icon": "ü•£", "price": 110}
                    ] %}
                    
                    {% for prep in preps %}
                    <div class="option-card radio-card {% if item and item.prepared == prep.name %}selected{% endif %}" data-price="{{ prep.price }}">
                        <input type="radio" id="{{ prep.id }}" name="prepared" value="{{ prep.name }}" required 
                            {% if item and item.prepared == prep.name %} checked {% endif %} class="hidden-input prepared-option">
                        <label for="{{ prep.id }}" class="card-content">
                            <div class="option-icon">{{ prep.icon }}</div>
                            <div class="option-name">{{ prep.name }}</div>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Hidden sauce field that automatically gets updated based on the prepared selection -->
                <input type="hidden" id="sauce_field" name="sauce" value="{{ item.sauce if item and item.sauce else (item.prepared if item and item.prepared else '') }}">
            </div>

            <!-- Step 5: Toppings (Optional) -->
            <div class="customization-step">
                <h2 class="step-title">5. ¬øToppings? (Opcional)</h2>
                <div class="option-grid topping-options">
                    <div class="option-card {% if item and 'Mango' in item.toppings %}selected{% endif %}">
                        <input type="checkbox" id="mango" name="toppings" value="Mango" 
                            {% if item and "Mango" in item.toppings %} checked {% endif %} class="hidden-input">
                        <label for="mango" class="card-content">
                            <div class="option-icon">ü•≠</div>
                            <div class="option-name">Mango</div>
                        </label>
                    </div>
                    
                    <div class="option-card {% if item and 'Cereza' in item.toppings %}selected{% endif %}">
                        <input type="checkbox" id="cereza" name="toppings" value="Cereza" 
                            {% if item and "Cereza" in item.toppings %} checked {% endif %} class="hidden-input">
                        <label for="cereza" class="card-content">
                            <div class="option-icon">üçí</div>
                            <div class="option-name">Cereza</div>
                        </label>
                    </div>
                    
                    <div class="option-card {% if item and 'Pi√±a' in item.toppings %}selected{% endif %}">
                        <input type="checkbox" id="pi√±a" name="toppings" value="Pi√±a" 
                            {% if item and "Pi√±a" in item.toppings %} checked {% endif %} class="hidden-input">
                        <label for="pi√±a" class="card-content">
                            <div class="option-icon">üçç</div>
                            <div class="option-name">Pi√±a</div>
                        </label>
                    </div>
                    
                    <div class="option-card {% if item and 'Fresa' in item.toppings %}selected{% endif %}">
                        <input type="checkbox" id="fresa" name="toppings" value="Fresa" 
                            {% if item and "Fresa" in item.toppings %} checked {% endif %} class="hidden-input">
                        <label for="fresa" class="card-content">
                            <div class="option-icon">üçì</div>
                            <div class="option-name">Fresa</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="customization-step">
                <h2 class="step-title">Notas (Opcional)</h2>
                <div class="notes-container">
                    <textarea name="notes" id="notes" rows="3" placeholder="A√±ade detalles o solicitudes adicionales..." class="notes-input">{% if item and item.notes %}{{ item.notes }}{% endif %}</textarea>
                </div>
            </div>

            <!-- Bottom Action Buttons -->
            <div class="action-buttons">
                <button type="button" id="cancel-btn" class="action-button cancel-button" data-url="{% if item %}{{ url_for('view_cart') }}{% else %}/{% endif %}">
                    <span class="button-icon">‚úï</span> Cancelar
                </button>
                <button type="submit" class="action-button submit-button">
                    <span class="button-icon">‚úì</span> {% if item %}Actualizar{% else %}Agregar al Carrito{% endif %}
                </button>
            </div>
        </form>
    </div>

    <style>
        /* Additional styles for enhanced ingredient selection */
        .sub-title {
            font-size: 1.2rem;
            color: #f5f5f5;
            margin: 20px 0 15px 0;
            font-weight: 600;
        }
        
        .premium-grid {
            display: grid;
            grid-template-columns: 1fr;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .premium-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #FF9800;
            color: #121212;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* Make sure Osti√≥n card looks like other ingredients */
        .premium-grid .option-card {
            position: relative;
            border: 2px solid #3D3D3D;
            background-color: #2D2D2D;
        }
        
        .premium-grid .option-card.selected {
            border-color: #FF9800;
            background-color: #3D3D3D;
        }
        
        .base-options {
            grid-template-columns: repeat(3, 1fr);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .premium-grid {
                max-width: 250px;
            }
        }
    </style>

    <!-- Enhanced JavaScript for sushi with Osti√≥n special handling -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // CANCEL BUTTON FIX - Add direct event listener
            const cancelBtn = document.getElementById('cancel-btn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    const url = this.getAttribute('data-url');
                    
                    if (url) {
                        window.location.href = url;
                    } else {
                        console.error('No URL provided for cancel button');
                        window.location.href = '/';
                    }
                });
            }
        
            // Apply initial selection states based on input checked status
            initializeSelections();
            
            // Set up option card selection
            setupOptionCardSelection();
            
            // Override the default ingredient limit for sushi
            const MAX_INGREDIENTS = 3;
            
            // Initialize ingredient validation (without counter display)
            initializeIngredientValidation();
            
            // Function to initialize ingredient validation (without display)
            function initializeIngredientValidation() {
                // Update the validation for sushi ingredients
                const ingredientCheckboxes = document.querySelectorAll('.ingredient-checkbox');
                
                ingredientCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            handleIngredientLimit(this, this.closest('.option-card'));
                        }
                    });
                });
            }
            
            // Function to handle ingredient limits with Osti√≥n special rules
            function handleIngredientLimit(checkbox, card) {
                const selectedIngredients = document.querySelectorAll('input[name="ingredients"]:checked');
                const regularIngredients = Array.from(selectedIngredients).filter(input => input.value !== 'Osti√≥n');
                const ostionIngredients = Array.from(selectedIngredients).filter(input => input.value === 'Osti√≥n');
                
                // If trying to add a regular ingredient and already have 3 regular ingredients
                if (checkbox.value !== 'Osti√≥n' && regularIngredients.length > MAX_INGREDIENTS) {
                    checkbox.checked = false;
                    card.classList.remove('selected');
                    alert('Solo puedes seleccionar hasta 3 ingredientes regulares.');
                    return;
                }
                
                // If trying to add Osti√≥n but already have 3 regular + osti√≥n
                if (checkbox.value === 'Osti√≥n' && regularIngredients.length >= MAX_INGREDIENTS && ostionIngredients.length > 1) {
                    checkbox.checked = false;
                    card.classList.remove('selected');
                    alert('Solo puedes agregar Osti√≥n como cuarto ingrediente cuando ya tienes 3 ingredientes regulares.');
                    return;
                }
            }
            
            // CRITICAL FIX: Properly handle the sauce field from prepared option
            const form = document.getElementById('customizationForm');
            const sauceField = document.getElementById('sauce_field');
            
            // Set up prepared option radio buttons to update hidden sauce field
            const preparedRadios = document.querySelectorAll('input[name="prepared"]');
            preparedRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked && sauceField) {
                        sauceField.value = this.value;
                    }
                });
                
                // Set initial value if radio is checked
                if (radio.checked && sauceField) {
                    sauceField.value = radio.value;
                }
            });
            
            // Make sure sauce field is properly initialized if a prepared option is already selected
            const selectedPrepared = document.querySelector('input[name="prepared"]:checked');
            if (selectedPrepared && sauceField && (!sauceField.value || sauceField.value.trim() === '')) {
                sauceField.value = selectedPrepared.value;
            }
            
            // Form submission validation
            if (form) {
                form.addEventListener('submit', function(event) {
                    // Check if at least 1 ingredient is selected
                    const selectedIngredients = document.querySelectorAll('.ingredient-checkbox:checked');
                    
                    if (selectedIngredients.length === 0) {
                        event.preventDefault();
                        alert('Por favor selecciona al menos 1 ingrediente.');
                        
                        // Add visual indication for the error
                        const ingredientsSection = document.querySelector('.ingredients-grid');
                        if (ingredientsSection) {
                            ingredientsSection.style.border = '2px solid #e74c3c';
                            ingredientsSection.style.backgroundColor = 'rgba(231, 76, 60, 0.05)';
                            
                            // Scroll to the ingredients section
                            ingredientsSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // Remove the visual indication after 3 seconds
                            setTimeout(function() {
                                ingredientsSection.style.border = '';
                                ingredientsSection.style.backgroundColor = '';
                            }, 3000);
                        }
                        return;
                    }
                    
                    // Check if style is selected
                    const styleSelected = document.querySelector('input[name="style"]:checked');
                    if (!styleSelected) {
                        event.preventDefault();
                        alert('Por favor selecciona si deseas tu sushi Fr√≠o o Empanizado.');
                        return;
                    }
                    
                    // Check if prepared option is selected
                    const preparedSelected = document.querySelector('input[name="prepared"]:checked');
                    if (!preparedSelected) {
                        event.preventDefault();
                        alert('Por favor selecciona una opci√≥n de preparado.');
                        return;
                    }
                    
                    // IMPORTANT FIX: Always ensure sauce has a value by copying from prepared
                    if (sauceField) {
                        sauceField.value = preparedSelected.value;
                    }
                    
                    // Check ingredient count with Osti√≥n exception
                    const regularIngredients = Array.from(selectedIngredients).filter(input => input.value !== 'Osti√≥n');
                    
                    if (regularIngredients.length > MAX_INGREDIENTS) {
                        event.preventDefault();
                        alert(`Solo puedes seleccionar hasta ${MAX_INGREDIENTS} ingredientes regulares para el sushi.`);
                        return;
                    }
                });
            }
            
            // Function to update ingredient counter
            function updateIngredientCounter() {
                const counter = document.getElementById('selected-count');
                const regularCounter = document.getElementById('regular-count');
                const ostionCounter = document.getElementById('ostion-count');
                
                if (!counter) return;
                
                const selectedIngredients = document.querySelectorAll('input[name="ingredients"]:checked');
                const regularIngredients = Array.from(selectedIngredients).filter(input => input.value !== 'Osti√≥n');
                const ostionIngredients = Array.from(selectedIngredients).filter(input => input.value === 'Osti√≥n');
                
                const regularCount = regularIngredients.length;
                const ostionCount = ostionIngredients.length;
                const totalCount = regularCount + ostionCount;
                
                counter.textContent = totalCount;
                if (regularCounter) regularCounter.textContent = regularCount;
                if (ostionCounter) ostionCounter.textContent = ostionCount;
                
                // Set color based on count
                if (regularCount > MAX_INGREDIENTS) {
                    counter.style.color = '#e74c3c'; // Red for over limit
                } else if (regularCount === MAX_INGREDIENTS) {
                    counter.style.color = '#f39c12'; // Orange for at limit
                } else {
                    counter.style.color = '#2ecc71'; // Green for under limit
                }
                
                // Update Osti√≥n availability message
                const ostionMessage = document.getElementById('ostion-message');
                if (ostionMessage) {
                    if (regularCount === MAX_INGREDIENTS && ostionCount === 0) {
                        ostionMessage.style.display = 'block';
                        ostionMessage.textContent = '¬°Ahora puedes agregar Osti√≥n como ingrediente adicional!';
                        ostionMessage.style.color = '#2ecc71';
                    } else if (regularCount < MAX_INGREDIENTS) {
                        ostionMessage.style.display = 'block';
                        ostionMessage.textContent = `Puedes agregar Osti√≥n cuando tengas ${MAX_INGREDIENTS} ingredientes regulares (tienes ${regularCount}).`;
                        ostionMessage.style.color = '#888';
                    } else {
                        ostionMessage.style.display = 'none';
                    }
                }
            }
            
            // Function to initialize selection states
            function initializeSelections() {
                // Handle checkboxes for base, ingredients, toppings
                document.querySelectorAll('.option-card input[type="checkbox"]').forEach(checkbox => {
                    const card = checkbox.closest('.option-card');
                    if (card && checkbox.checked) {
                        card.classList.add('selected');
                    }
                });
                
                // Handle radio buttons for style and prepared
                document.querySelectorAll('.option-card input[type="radio"]').forEach(radio => {
                    const card = radio.closest('.option-card');
                    if (card && radio.checked) {
                        card.classList.add('selected');
                    }
                });
            }
            
            // Function to handle option card selection visual feedback
            function setupOptionCardSelection() {
                // Handle checkbox options (base, ingredients, toppings)
                document.querySelectorAll('.option-card').forEach(card => {
                    const checkbox = card.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        card.addEventListener('click', function(e) {
                            // Skip if click was directly on input or label
                            if (e.target === checkbox || 
                                e.target.tagName === 'LABEL' || 
                                e.target.closest('label')) {
                                return;
                            }
                            
                            // Toggle checkbox
                            checkbox.checked = !checkbox.checked;
                            
                            // Update visual selection
                            this.classList.toggle('selected', checkbox.checked);
                            
                            // If this is an ingredient checkbox, handle limits
                            if (checkbox.classList.contains('ingredient-checkbox')) {
                                const selectedCount = document.querySelectorAll('.ingredient-checkbox:checked').length;
                                const regularIngredients = Array.from(document.querySelectorAll('.ingredient-checkbox:checked')).filter(input => input.value !== 'Osti√≥n');
                                
                                if (checkbox.value !== 'Osti√≥n' && regularIngredients.length > MAX_INGREDIENTS && checkbox.checked) {
                                    checkbox.checked = false;
                                    this.classList.remove('selected');
                                    alert(`Solo puedes seleccionar hasta ${MAX_INGREDIENTS} ingredientes regulares para el sushi.`);
                                }
                            }
                            
                            // Dispatch change event to trigger any other listeners
                            const changeEvent = new Event('change', { bubbles: true });
                            checkbox.dispatchEvent(changeEvent);
                        });
                    }
                    
                    const radio = card.querySelector('input[type="radio"]');
                    if (radio) {
                        card.addEventListener('click', function(e) {
                            // Skip if click was directly on input or label
                            if (e.target === radio || 
                                e.target.tagName === 'LABEL' || 
                                e.target.closest('label')) {
                                return;
                            }
                            
                            // Set radio as checked
                            radio.checked = true;
                            
                            // Update visual selection for all radios in the same group
                            const name = radio.getAttribute('name');
                            document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                                const c = r.closest('.option-card');
                                if (c) {
                                    c.classList.remove('selected');
                                }
                            });
                            this.classList.add('selected');
                            
                            // For sushi preparation, update the hidden sauce field if needed
                            if (name === 'prepared') {
                                const sauceField = document.getElementById('sauce_field');
                                if (sauceField) {
                                    sauceField.value = radio.value;
                                    console.log('Updated sauce field from card click:', radio.value);
                                }
                            }
                            
                            // Dispatch change event to trigger any other listeners
                            const changeEvent = new Event('change', { bubbles: true });
                            radio.dispatchEvent(changeEvent);
                        });
                    }
                });
                
                // Also add listeners to inputs themselves
                document.querySelectorAll('.option-card input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const card = this.closest('.option-card');
                        if (card) {
                            card.classList.toggle('selected', this.checked);
                        }
                    });
                });
                
                document.querySelectorAll('.option-card input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        const name = this.getAttribute('name');
                        document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                            const c = r.closest('.option-card');
                            if (c) {
                                c.classList.toggle('selected', r.checked);
                            }
                        });
                    });
                });
            }
        });
    </script>
</body>
</html>